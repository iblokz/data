name: Deploy Docs

on:
  push:
    branches: [ master, main ]
    paths:
      - 'lib/**'
      - 'README.md'
      - 'docs/**'
      - '.github/workflows/docs.yml'

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Generate API documentation
      run: npm run docs
    
    - name: Generate HTML docs with JSDoc
      run: |
        npx jsdoc -c .jsdoc.json
        
        # Inject custom theme CSS into JSDoc HTML files
        find _site/api -name "*.html" -type f -exec sed -i 's|</head>|<link rel="stylesheet" href="../jsdoc-theme.css"></head>|' {} \;
    
    - name: Convert markdown to HTML
      run: |
        # Install markdown converter
        npm install -g marked
        
        # Convert README.md to HTML
        cat > convert.js << 'SCRIPT'
        const fs = require('fs');
        const { marked } = require('marked');
        
        const readmeMd = fs.readFileSync('README.md', 'utf8');
        const apiMd = fs.readFileSync('API.md', 'utf8');
        
        const template = (title, content) => `<!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${title} - iblokz-data</title>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.0/github-markdown-light.min.css">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
          <style>
            :root {
              --bg-color: #ffffff;
              --text-color: #24292f;
              --border-color: #d0d7de;
              --code-bg: #f6f8fa;
            }
            
            @media (prefers-color-scheme: dark) {
              :root {
                --bg-color: #0d1117;
                --text-color: #c9d1d9;
                --border-color: #30363d;
                --code-bg: #161b22;
              }
            }
            
            body { 
              max-width: 980px; 
              margin: 0 auto; 
              padding: 45px;
              background-color: var(--bg-color);
              color: var(--text-color);
            }
            
            .markdown-body { 
              box-sizing: border-box; 
              min-width: 200px; 
              max-width: 980px; 
              margin: 0 auto;
              background-color: var(--bg-color);
              color: var(--text-color);
            }
            
            /* Code block styling */
            .markdown-body pre {
              background-color: var(--code-bg) !important;
            }
            
            .markdown-body code {
              background-color: var(--code-bg);
            }
            
            @media (max-width: 767px) { 
              body { padding: 15px; } 
            }
          </style>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
          <script>hljs.highlightAll();</script>
        </head>
        <body>
          <article class="markdown-body">
            ${content}
          </article>
        </body>
        </html>`;
        
        fs.writeFileSync('README.html', template('README', marked(readmeMd)));
        fs.writeFileSync('API.html', template('API Reference', marked(apiMd)));
        SCRIPT
        
        node convert.js
    
    - name: Create docs site
      run: |
        mkdir -p _site
        
        # Copy converted HTML files
        cp README.html _site/
        cp API.html _site/
        
        # Copy JSDoc theme CSS
        cp jsdoc-theme.css _site/
        
        # Also keep original .md files for direct access
        cp README.md _site/
        cp API.md _site/
        
        # Create a simple index.html
        cat > _site/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>iblokz-data Documentation</title>
          <style>
            :root {
              --bg-color: #ffffff;
              --text-color: #24292f;
              --text-secondary: #57606a;
              --border-color: #d0d7de;
              --heading-color: #2c3e50;
              --accent-color: #3498db;
              --card-bg: #ffffff;
              --card-border: #e0e0e0;
              --card-hover-shadow: rgba(52, 152, 219, 0.15);
            }
            
            @media (prefers-color-scheme: dark) {
              :root {
                --bg-color: #0d1117;
                --text-color: #c9d1d9;
                --text-secondary: #8b949e;
                --border-color: #30363d;
                --heading-color: #58a6ff;
                --accent-color: #58a6ff;
                --card-bg: #161b22;
                --card-border: #30363d;
                --card-hover-shadow: rgba(88, 166, 255, 0.2);
              }
            }
            
            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
              max-width: 1200px;
              margin: 0 auto;
              padding: 2rem;
              line-height: 1.6;
              background-color: var(--bg-color);
              color: var(--text-color);
              transition: background-color 0.3s, color 0.3s;
            }
            
            h1 { 
              color: var(--heading-color); 
              border-bottom: 2px solid var(--accent-color); 
              padding-bottom: 0.5rem; 
            }
            
            .links { 
              display: grid; 
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
              gap: 1rem; 
              margin-top: 2rem; 
            }
            
            .link-card {
              padding: 1.5rem;
              background-color: var(--card-bg);
              border: 1px solid var(--card-border);
              border-radius: 8px;
              text-decoration: none;
              color: var(--text-color);
              transition: all 0.3s;
            }
            
            .link-card:hover {
              border-color: var(--accent-color);
              box-shadow: 0 4px 12px var(--card-hover-shadow);
              transform: translateY(-2px);
            }
            
            .link-card h2 { 
              margin-top: 0; 
              color: var(--accent-color); 
            }
            
            .link-card p { 
              margin-bottom: 0; 
              color: var(--text-secondary); 
            }
            
            footer { 
              margin-top: 3rem; 
              padding-top: 2rem; 
              border-top: 1px solid var(--border-color); 
              text-align: center; 
              color: var(--text-secondary); 
            }
          </style>
        </head>
        <body>
          <h1>üì¶ iblokz-data Documentation</h1>
          <p>Immutable data manipulation utilities for JavaScript</p>
          
          <div class="links">
            <a href="README.html" class="link-card">
              <h2>üìñ Getting Started</h2>
              <p>Installation, quick start guide, and usage examples</p>
            </a>
            
            <a href="API.html" class="link-card">
              <h2>üìö API Reference</h2>
              <p>Complete API documentation with all functions</p>
            </a>
            
            <a href="api/index.html" class="link-card">
              <h2>üîç JSDoc Browser</h2>
              <p>Interactive API browser generated from JSDoc</p>
            </a>
            
            <a href="https://github.com/iblokz/data" class="link-card">
              <h2>üíª GitHub Repository</h2>
              <p>Source code, issues, and contributions</p>
            </a>
            
            <a href="https://www.npmjs.com/package/iblokz-data" class="link-card">
              <h2>üì¶ npm Package</h2>
              <p>Install and view package information</p>
            </a>
          </div>
          
          <footer>
            <p>Built with ‚ù§Ô∏è by the iblokz-data team | MIT License</p>
          </footer>
        </body>
        </html>
        EOF
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
  
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

